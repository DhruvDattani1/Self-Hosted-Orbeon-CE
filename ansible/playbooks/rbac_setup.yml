- name: Apply Namespaces and RBAC to K3s
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    ansible_python_interpreter: "{{ ansible_playbook_python }}"
    kubeconfig_path: "{{ lookup('env', 'HOME') + '/.kube/config' }}"
    manifest_root: "{{ playbook_dir }}/../../k8s-manifests/rbac-proxy"

  tasks:
    - name: Apply namespaces first
      kubernetes.core.k8s:
        state: present
        src: "{{ manifest_root }}/namespaces.yml"
        kubeconfig: "{{ kubeconfig_path }}"

    - name: Apply RBAC manifests
      kubernetes.core.k8s:
        state: present
        src: "{{ item }}"
        kubeconfig: "{{ kubeconfig_path }}"
      loop: "{{ lookup('fileglob', manifest_root + '/rbac-*.yml', wantlist=True) + lookup('fileglob', manifest_root + '/rbac-*.yaml', wantlist=True) }}"
