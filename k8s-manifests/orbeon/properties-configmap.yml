apiVersion: v1
kind: ConfigMap
metadata:
  name: orbeon-properties
  namespace: orbeon
data:
  properties-prod.xml: |
    <properties xmlns="http://www.orbeon.com/oxf/xml/properties"
                xmlns:xs="http://www.w3.org/2001/XMLSchema"
                xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
                xmlns:xxf="http://orbeon.org/oxf/xml/xforms">

      <!-- Disable fallback persistence providers -->
      <property as="xs:boolean" name="oxf.fr.persistence.sqlite.active" value="false"/>
      <property as="xs:boolean" name="oxf.fr.persistence.exist.active" value="false"/>
      <property as="xs:string"  name="oxf.fr.persistence.provider.demo.*.*" value=""/>

      <!-- Force PostgreSQL for all apps/forms/stages -->
      <property as="xs:string" name="oxf.fr.persistence.provider.*.*.form" value="postgresql"/>
      <property as="xs:string" name="oxf.fr.persistence.provider.*.*.data" value="postgresql"/>
      <property as="xs:string" name="oxf.fr.persistence.provider.*.*.*.attachments" value="postgresql"/>
      <property as="xs:string" name="oxf.fr.persistence.provider.*.*.*.draft" value="postgresql"/>

      <!-- Explicit override for Form Builder app -->
      <property as="xs:string" name="oxf.fr.persistence.provider.orbeon.*.form" value="postgresql"/>
      <property as="xs:string" name="oxf.fr.persistence.provider.orbeon.*.data" value="postgresql"/>

      <!-- PostgreSQL JNDI Datasource (ONLY) -->
      <property as="xs:string" name="oxf.fr.persistence.postgresql.datasource" value="java:comp/env/jdbc/orbeon"/>

      <!-- REMOVED: All direct datasource properties that conflict with JNDI -->
      <!-- Your context.xml handles the connection details -->

      <!-- MinIO / S3 Binary Attachment Support -->
      <property as="xs:string" name="oxf.fr.attachment.storage" value="s3"/>
      <property as="xs:string" name="oxf.fr.attachment.s3.bucket" value="orbeon-forms"/>
      <property as="xs:string" name="oxf.fr.attachment.s3.access-key" value="admin"/>
      <property as="xs:string" name="oxf.fr.attachment.s3.secret-key" value="changeit"/>
      <property as="xs:string" name="oxf.fr.attachment.s3.region" value="us-east-1"/>
      <property as="xs:string" name="oxf.fr.attachment.s3.endpoint" value="http://minio.storage.svc.cluster.local:9000"/>
      <property as="xs:boolean" name="oxf.fr.attachment.s3.path-style-access" value="true"/>

      <!-- Draft and versioning config -->
      <property as="xs:boolean" name="oxf.fr.detail.save.draft" value="true"/>
      <property as="xs:boolean" name="oxf.fr.persistence.versioning" value="true"/>

      <!-- Enable debug logging for persistence -->
      <property as="xs:string" name="oxf.logging.level.org.orbeon.oxf.fr.persistence" value="debug"/>
      <property as="xs:string" name="oxf.logging.level.org.orbeon.oxf.fr.persistence.relational" value="debug"/>
      <property as="xs:string" name="oxf.logging.level.org.orbeon.oxf.fr.persistence.postgresql" value="debug"/>

      <!-- General logging & diagnostics -->
      <property as="xs:boolean" name="oxf.logging.config" value="true"/>
      <property as="xs:boolean" name="oxf.xforms.logging.log-xforms-submission" value="true"/>
      <property as="xs:boolean" name="oxf.xforms.submission.trace" value="true"/>
      <property as="xs:boolean" name="oxf.xforms.xbl.allow-dynamic-xbl-loading" value="true"/>

    </properties>